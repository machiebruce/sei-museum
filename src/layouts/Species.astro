---
import Layout from "./Main-Layout.astro";
import Menu from "../components/Menu.astro";
import Buttons from "../components/Buttons.astro";
import fs from "node:fs";
import path from "node:path";

const {frontmatter, url} = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");

// --- LOGICA AUTOMAZIONE GALLERIA ---
const slug = url ? path.basename(url) : "default";
const cleanSlug = slug.replace(/\.[^/.]+$/, "");

const galleryDir = path.join(process.cwd(), "public", "galleria", cleanSlug);
let galleryImages: string[] = [];

if (fs.existsSync(galleryDir)) {
  galleryImages = fs
    .readdirSync(galleryDir)
    .filter((file: string) => /\.(jpg|jpeg|png|webp|avif|svg|jog|JPG|JPEG)$/i.test(file))
    .map((file: string) => `${baseUrl}/galleria/${cleanSlug}/${file}`);
}

if (galleryImages.length === 0) {
  galleryImages = ["https://placehold.co/800x450/262626/ffffff?text=Immagine+non+trovata"];
}

// --- LOGICA NAVIGAZIONE AUTOMATICA ---
const allSpecies = await Astro.glob("../pages/species/*.mdx");

console.log("\n=== DEBUG NAVIGAZIONE ===");
console.log("Totale specie trovate:", allSpecies.length);

// Ordina per sectionNumber (CONVERSIONE ESPLICITA A NUMERO)
const sortedSpecies = allSpecies.sort((a, b) => {
  const numA = Number(a.frontmatter.sectionNumber) || 999;
  const numB = Number(b.frontmatter.sectionNumber) || 999;
  return numA - numB;
});

// Stampa l'ordinamento
console.log("\nSpecie ordinate:");
sortedSpecies.forEach((s, idx) => {
  console.log(`${idx}: [${s.frontmatter.sectionNumber}] ${s.frontmatter.title} - ${s.frontmatter.link}`);
});

// Trova l'indice corrente
console.log("\nCercando pagina corrente...");
console.log("Current frontmatter.link:", frontmatter.link);
console.log("Current url:", url);

const currentIndex = sortedSpecies.findIndex((species) => species.frontmatter.link === frontmatter.link);

console.log("Current index trovato:", currentIndex);

if (currentIndex !== -1) {
  console.log("Pagina corrente:", sortedSpecies[currentIndex].frontmatter.title);
}

// Determina prev e next
const prevSpecies = currentIndex > 0 ? sortedSpecies[currentIndex - 1] : null;
const nextSpecies = currentIndex >= 0 && currentIndex < sortedSpecies.length - 1 ? sortedSpecies[currentIndex + 1] : null;

console.log("\nNavigazione:");
console.log("Prev:", prevSpecies?.frontmatter.title || "NESSUNO");
console.log("Next:", nextSpecies?.frontmatter.title || "NESSUNO");

const prevSection = prevSpecies?.frontmatter?.link || null;
const nextSection = nextSpecies?.frontmatter?.link || null;

console.log("\nLink navigazione:");
console.log("prevSection:", prevSection);
console.log("nextSection:", nextSection);
console.log("=== FINE DEBUG ===\n");
---

<style is:global>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Forzatura colore bianco totale */
  .force-white,
  .force-white * {
    color: #ffffff !important;
  }

  /* RIMOZIONE PUNTI ELENCO */
  .force-white ul,
  .force-white ol {
    list-style: none !important;
    padding-left: 0 !important;
    margin-bottom: 1rem !important;
  }

  .force-white ul li,
  .force-white ol li {
    margin-bottom: 0.5rem !important;
    padding-left: 0 !important;
  }

  .force-white ul li::marker,
  .force-white ol li::marker {
    display: none !important;
    content: none !important;
  }

  /* GESTIONE LINK */
  .force-white a {
    color: #ffffff !important;
    text-decoration: none !important;
    cursor: pointer !important;
    position: relative;
    z-index: 20;
  }
  .force-white a:hover {
    color: rgb(231, 121, 104) !important;
  }

  .carousel-container {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  .carousel-item {
    flex: 0 0 100%;
    scroll-snap-align: start;
    cursor: pointer;
  }
  .dot {
    cursor: pointer;
  }
  .dot.active {
    background-color: white !important;
    width: 1.5rem;
  }

  /* MODAL FULLSCREEN */
  .modal-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-fullscreen.active {
    display: flex;
  }

  .modal-image {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
  }

  .modal-nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    padding: 1rem;
    cursor: pointer;
    border-radius: 50%;
    transition: background 0.3s;
    z-index: 10000;
  }

  .modal-nav-button:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .modal-close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    padding: 1rem;
    cursor: pointer;
    border-radius: 50%;
    transition: background 0.3s;
    z-index: 10000;
  }

  .modal-close:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  /* Icone accordion */
  .accordion-section-icon {
    margin-right: 0.75rem;
    font-size: 1.5rem;
    color: rgb(231, 121, 104);
  }

  /* Stile link sezione fonti */
  .section-link {
    display: block;
    text-decoration: none;
    transition: all 0.3s;
  }

  .section-link:hover {
    transform: translateX(4px);
  }

  /* Sezione credits compatta */
  .content-compact,
  .content-compact * {
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
  }

  /* Layout a due colonne per Descrizione della Specie */
  .species-description-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 1rem;
  }

  .species-description-grid > div {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .species-description-grid strong {
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgb(231, 121, 104);
    margin-bottom: 0.25rem;
  }

  .species-description-grid p {
    margin: 0;
    line-height: 1.6;
  }

  /* Responsive: singola colonna su schermi piccoli */
  @media (max-width: 768px) {
    .species-description-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<Layout title={frontmatter.title}>
  <!-- Material Icons -->
  <link href='https://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet' />

  

  <main class='flex flex-row h-screen overflow-hidden bg-neutral-900'>
    <Menu HasSectionNumber={false} variant='flora' title={frontmatter.title || "Specie"} />

    <div class='grid grid-cols-2 gap-12 w-full p-32 overflow-y-auto no-scrollbar'>
      <div class='flex flex-col gap-y-8 sticky top-0 self-start'>
        <div class='text-white space-y-2'>
          <h1 class='text-4xl font-bold text-white'>{frontmatter.title}</h1>
          {frontmatter.scientificName && <p class='text-2xl font-light italic text-white/60'>{frontmatter.scientificName}</p>}
        </div>

        <!-- Carousel Galleria -->
        <div class='relative group overflow-hidden rounded-2xl border border-white/10 bg-neutral-800 shadow-2xl'>
          <div id='carousel' class='carousel-container no-scrollbar'>
            {
              galleryImages.map((img: string, index: number) => (
                <div class='carousel-item aspect-video bg-neutral-800' data-image-index={index}>
                  <img src={img} class='w-full h-full object-cover' alt={`Slide ${index}`} />
                </div>
              ))
            }
          </div>

          <button id='prevBtn' class='absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/80 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10'>
            <svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7'></path></svg>
          </button>
          <button id='nextBtn' class='absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/80 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10'>
            <svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5l7 7-7 7'></path></svg>
          </button>

          <div class='absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-10'>
            {galleryImages.map((_: string, index: number) => <div class='dot h-1.5 w-1.5 rounded-full bg-white/30 transition-all duration-300' data-index={index} />)}
          </div>
        </div>

        <div id='species-description' class='prose prose-invert max-w-none text-white text-xl force-white'></div>

        <!-- Page Controls -->
        <div class='flex gap-4 w-full'>
          {frontmatter.videoLink && <Buttons hasIconLeft={true} srcIcon='/sei-museum/monitorPlay.svg' label='Video' link={frontmatter.videoLink} />}
          <span class='flex-1'></span>
          {prevSection && <Buttons hasIconLeft={true} srcIcon='/sei-museum/arrowLeft.svg' label='' link={prevSection} />}
          {nextSection && <Buttons hasIconRight={true} srcIcon='/sei-museum/arrowRight.svg' label='Prossimo contenuto' link={nextSection} />}
        </div>
      </div>

      <div class='flex flex-col overflow-visible'>
        <div id='species-sections-container' class='flex flex-col gap-6 overflow-visible py-[72px] force-white'>
          <div id='species-full-content' style='display: none;'>
            <slot />
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Fullscreen -->
    <div id='modal-fullscreen' class='modal-fullscreen'>
      <button id='modal-close' class='modal-close'>
        <svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
          <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path>
        </svg>
      </button>
      <button id='modal-prev' class='modal-nav-button' style='left: 2rem;'>
        <svg class='w-8 h-8' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
          <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7'></path>
        </svg>
      </button>
      <img id='modal-image' class='modal-image' src='' alt='Fullscreen image' />
      <button id='modal-next' class='modal-nav-button' style='right: 2rem;'>
        <svg class='w-8 h-8' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
          <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5l7 7-7 7'></path>
        </svg>
      </button>
    </div>
  </main>

  <script is:inline define:vars={{galleryImages, baseUrl}}>
    (function () {
      // Logica Carousel e Navigazione
      const carousel = document.getElementById("carousel");
      const dots = document.querySelectorAll(".dot");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      let currentIndex = 0;

      function scrollToSlide(index) {
        if (!carousel) return;
        currentIndex = index;
        carousel.scrollTo({left: carousel.offsetWidth * index, behavior: "smooth"});
        dots.forEach((dot, i) => dot.classList.toggle("active", i === index));
      }

      if (dots.length > 0) {
        dots.forEach((dot, i) =>
          dot.addEventListener("click", () => {
            clearInterval(autoTimer);
            scrollToSlide(i);
          }),
        );
        prevBtn?.addEventListener("click", () => {
          clearInterval(autoTimer);
          scrollToSlide(currentIndex === 0 ? dots.length - 1 : currentIndex - 1);
        });
        nextBtn?.addEventListener("click", () => {
          clearInterval(autoTimer);
          scrollToSlide((currentIndex + 1) % dots.length);
        });
        carousel?.addEventListener("scroll", () => {
          const index = Math.round(carousel.scrollLeft / carousel.offsetWidth);
          if (index !== currentIndex) {
            currentIndex = index;
            dots.forEach((dot, i) => dot.classList.toggle("active", i === index));
          }
        });
        let autoTimer = setInterval(() => scrollToSlide((currentIndex + 1) % dots.length), 5000);
        dots[0].classList.add("active");
      }

      // Modal Fullscreen
      const modal = document.getElementById("modal-fullscreen");
      const modalImage = document.getElementById("modal-image");
      const modalClose = document.getElementById("modal-close");
      const modalPrev = document.getElementById("modal-prev");
      const modalNext = document.getElementById("modal-next");
      let modalCurrentIndex = 0;

      function openModal(index) {
        modalCurrentIndex = index;
        modalImage.src = galleryImages[index];
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        modal.classList.remove("active");
        document.body.style.overflow = "";
      }

      function showModalImage(index) {
        if (index < 0) index = galleryImages.length - 1;
        if (index >= galleryImages.length) index = 0;
        modalCurrentIndex = index;
        modalImage.src = galleryImages[index];
      }

      // Click sulle immagini del carousel
      document.querySelectorAll(".carousel-item").forEach((item, index) => {
        item.addEventListener("click", () => openModal(index));
      });

      modalClose?.addEventListener("click", closeModal);
      modalPrev?.addEventListener("click", () => showModalImage(modalCurrentIndex - 1));
      modalNext?.addEventListener("click", () => showModalImage(modalCurrentIndex + 1));

      // Chiusura con ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
        if (modal.classList.contains("active")) {
          if (e.key === "ArrowLeft") showModalImage(modalCurrentIndex - 1);
          if (e.key === "ArrowRight") showModalImage(modalCurrentIndex + 1);
        }
      });

      // Chiusura cliccando fuori dall'immagine
      modal?.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      // Funzione per ottenere l'icona appropriata
      function getIconForSection(title) {
        const lowerTitle = title.toLowerCase();
        if (lowerTitle.includes("distribuzione") || lowerTitle.includes("habitat")) return "public";
        if (lowerTitle.includes("descrizione") || lowerTitle.includes("specie")) return "pets";
        if (lowerTitle.includes("credit") || lowerTitle.includes("fotograf")) return "photo_camera";
        if (lowerTitle.includes("fonti") || lowerTitle.includes("risorse")) return "menu_book";
        return "info";
      }

      // Funzione per creare il link Fonti
      function createFontiLink(container) {
        const linkDiv = document.createElement("a");
        linkDiv.href = `${baseUrl}/fonti`;
        linkDiv.className = "section-link bg-neutral-900 border border-white/10 rounded-2xl overflow-hidden";
        linkDiv.innerHTML = `
          <div class="w-full text-left p-6 text-white hover:bg-black/50 transition-colors flex items-center justify-between">
            <div class="flex items-center">
              <span class="material-icons accordion-section-icon">menu_book</span>
              <h3 class="text-lg font-bold text-white">Fonti e Risorse per Approfondire</h3>
            </div>
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>`;
        container.appendChild(linkDiv);
      }

      // Estrazione sezioni dal Markdown
      function extractSections() {
        const fullContentDiv = document.getElementById("species-full-content");
        const container = document.getElementById("species-sections-container");
        const descContainer = document.getElementById("species-description");
        if (!fullContentDiv || !container) return;

        // Estrai il primo paragrafo per la descrizione
        const firstP = fullContentDiv.querySelector("p");
        if (firstP && descContainer) descContainer.innerHTML = firstP.outerHTML;

        // Cerca le sezioni h4
        const headings = fullContentDiv.querySelectorAll("h4");
        const sections = [];

        headings.forEach((heading) => {
          const headingText = heading.textContent.trim().replace(/\*\*/g, "").trim();
          let content = "";
          let nextElement = heading.nextElementSibling;

          while (nextElement && !nextElement.matches("h4")) {
            content += nextElement.outerHTML;
            nextElement = nextElement.nextElementSibling;
          }

          if (content.trim()) {
            sections.push({title: headingText, content: content.trim()});
          }
        });

        // Crea gli accordion per le sezioni
        sections.forEach((section, index) => {
          const lowerTitle = section.title.toLowerCase();
          const isFonti = lowerTitle.includes("fonti");
          const isCredits = lowerTitle.includes("credit") || lowerTitle.includes("fotograf");

          if (!isFonti) {
            // Accordion normale
            const accordionId = `accordion-${index}`;
            const icon = getIconForSection(section.title);

            const accordionDiv = document.createElement("div");
            accordionDiv.className = "bg-neutral-900 border border-white/10 rounded-2xl transition-all duration-300 overflow-hidden";
            accordionDiv.innerHTML = `
              <button class="accordion-button w-full text-left p-6 text-white hover:bg-black/50 transition-colors flex items-center justify-between" data-accordion-id="${accordionId}">
                <div class="flex items-center">
                  <span class="material-icons accordion-section-icon">${icon}</span>
                  <h3 class="text-lg font-bold text-white">${section.title}</h3>
                </div>
                <svg class="accordion-icon w-5 h-5 transition-transform duration-300 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </button>
              <div class="accordion-content hidden p-6 pt-0 prose prose-invert max-w-none text-white force-white ${isCredits ? "content-compact" : ""}" id="${accordionId}">
                ${section.content}
              </div>`;
            container.appendChild(accordionDiv);
          }
        });

        // Aggiungi sempre il link a Fonti e Risorse alla fine
        createFontiLink(container);

        // Event listeners per gli accordion
        container.querySelectorAll(".accordion-button").forEach((button) => {
          button.addEventListener("click", function () {
            const targetId = this.getAttribute("data-accordion-id");
            const targetContent = document.getElementById(targetId);
            const isOpening = targetContent.classList.contains("hidden");

            document.querySelectorAll(".accordion-content").forEach((c) => c.classList.add("hidden"));
            document.querySelectorAll(".accordion-icon").forEach((i) => (i.style.transform = "rotate(0deg)"));

            if (isOpening) {
              targetContent.classList.remove("hidden");
              this.querySelector(".accordion-icon").style.transform = "rotate(180deg)";
              setTimeout(() => this.scrollIntoView({behavior: "smooth", block: "start"}), 150);
            }
          });
        });

        fullContentDiv.remove();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", extractSections);
      } else {
        extractSections();
      }
    })();
  </script>
</Layout>
