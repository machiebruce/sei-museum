---
import Layout from "../layouts/Main-Layout.astro";
import Menu from "../components/Menu.astro";
import CardSpecie from "../components/CardSpecie.astro";

const objects = await Astro.glob("../pages/species/*.mdx");
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");

// Estrai le famiglie uniche
const families = new Set<string>();
const familyIconMap = new Map<string, string>();

objects.forEach((obj) => {
  if (obj.frontmatter.family) {
    families.add(obj.frontmatter.family);
    if (obj.frontmatter["family-icon"]) {
      familyIconMap.set(obj.frontmatter.family, obj.frontmatter["family-icon"]);
    }
  }
});

const uniqueFamilies = Array.from(families).sort();
---

<style>
  /* Inversione icona SVG */
  .filter-tab.active .filter-tab-icon:not(.material-icons) {
    filter: invert(1);
  }
</style>

<Layout title='Saline Ettore Infersa'>
  <link href='https://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet' />

  <main class='flex flex-col h-screen overflow-hidden relative'>
    <div class='flex flex-row flex-1 overflow-hidden'>
      <Menu HasSectionNumber={false} title='Le specie delle saline' />

      <div class='flex flex-col flex-1 overflow-hidden'>
        <!-- Toggle Buttons -->
        <div class='absolute top-6 right-6 z-50 flex items-center gap-4'>
          <a href={`${baseUrl}/species`} class='border border-white flex items-center gap-2 px-6 py-3 bg-neutral-800 text-white rounded-xl hover:bg-neutral-700 no-underline'>
            <span class='material-icons'>view_column</span>
          </a>

          <a href={`${baseUrl}/species-map`} class='flex items-center gap-2 px-6 py-3 bg-neutral-800 text-white rounded-xl hover:bg-neutral-700 no-underline'>
            <span class='material-icons'>image_search</span>
          </a>
        </div>

        <!-- List View -->
        <div class='snap-x flex-1 flex items-center justify-start gap-16 overflow-x-scroll scroll-pr-72 no-scrollbar'>
          {
            objects.map((object) => (
              <div class='species-card flex-shrink-0 flex-grow-0' data-family={object.frontmatter.family || "undefined"}>
                <CardSpecie sectionNumber={object.frontmatter.sectionNumber} title={object.frontmatter.title} href={object.frontmatter.link} image={object.frontmatter.image} IsFauna={object.frontmatter.IsFauna} />
              </div>
            ))
          }
          <div class='min-w-32'></div>
        </div>

        <!-- Tab Filtri in basso -->
        <div class='px-8 pt-4 pb-8'>
          <p class='text-white text-2xl font-bold mb-4'>Famiglie / Family</p>
          <div class='flex flex-wrap items-center gap-3'>
            <button class='filter-tab active h-16 px-6 bg-white border-white rounded-full text-black font-semibold text-sm cursor-pointer uppercase tracking-wider whitespace-nowrap flex items-center gap-2' data-family='all'> Tutte </button>
            {
              uniqueFamilies.map((family) => {
                const icon = familyIconMap.get(family);
                return (
                  <button class='filter-tab h-16 px-6 bg-white/10 border border-white/20 rounded-full text-white font-semibold text-sm cursor-pointer uppercase tracking-wider whitespace-nowrap flex items-center gap-2' data-family={family}>
                    {icon ? <img src={icon} alt={family} class='filter-tab-icon w-10 h-10 flex-shrink-0' /> : <span class='material-icons filter-tab-icon w-10 h-10 text-[28px] leading-none flex items-center justify-center'>category</span>}
                    {family}
                  </button>
                );
              })
            }
          </div>
        </div>
      </div>
    </div>
  </main>

  <script is:inline>
    (function () {
      const filterTabs = document.querySelectorAll(".filter-tab");
      const speciesCards = document.querySelectorAll(".species-card");

      // Cache dei risultati per famiglia
      const familyCache = new Map();

      // Pre-calcola quali card appartengono a quale famiglia
      speciesCards.forEach((card) => {
        const family = card.getAttribute("data-family");
        if (!familyCache.has(family)) {
          familyCache.set(family, []);
        }
        familyCache.get(family).push(card);
      });

      function updateFirstVisibleMargin() {
        let firstFound = false;
        speciesCards.forEach((card) => {
          if (!firstFound && card.style.display !== "none") {
            card.classList.add("ml-16");
            firstFound = true;
          } else {
            card.classList.remove("ml-16");
          }
        });
      }

      updateFirstVisibleMargin();

      filterTabs.forEach((tab) => {
        tab.addEventListener("click", function () {
          const selectedFamily = this.getAttribute("data-family");

          // Aggiorna stato attivo
          filterTabs.forEach((t) => {
            if (t === this) {
              t.className = "filter-tab active h-16 px-6 bg-white border-white rounded-full text-black font-semibold text-sm cursor-pointer uppercase tracking-wider whitespace-nowrap flex items-center gap-2";
              const icon = t.querySelector(".material-icons");
              if (icon) icon.classList.add("text-black");
            } else {
              t.className = "filter-tab h-16 px-6 bg-white/10 border border-white/20 rounded-full text-white font-semibold text-sm cursor-pointer uppercase tracking-wider whitespace-nowrap flex items-center gap-2";
              const icon = t.querySelector(".material-icons");
              if (icon) icon.classList.remove("text-black");
            }
          });

          // Filtraggio ottimizzato
          if (selectedFamily === "all") {
            speciesCards.forEach((card) => {
              card.style.display = "";
            });
          } else {
            speciesCards.forEach((card) => {
              card.style.display = card.getAttribute("data-family") === selectedFamily ? "" : "none";
            });
          }

          updateFirstVisibleMargin();
        });
      });
    })();
  </script>
</Layout>
